!function(){if(window.N8nChatWidgetLoaded)return;window.N8nChatWidgetLoaded=!0;let e=function e(t,r){let a={...t};for(let n in r)r[n]&&"object"==typeof r[n]&&!Array.isArray(r[n])?a[n]=e(t[n]||{},r[n]):void 0!==r[n]&&""!==r[n]&&(a[n]=r[n]);return a}({webhook:{url:"",route:"general"},branding:{botName:"AI Assistant",botStatus:"Online",botAvatar:"",showBotAvatar:!0,welcomeTitle:"Hallo! \uD83D\uDC4B",welcomeSubtitle:"Wie kann ich dir heute helfen?",welcomeButtonText:"Chat starten",inputPlaceholder:"Schreibe eine Nachricht...",launcherText:"Chat",launcherIcon:"chat",footerText:"Powered by n8n",footerLink:"https://n8n.io",showFooter:!0},initialMessage:{enabled:!0,delay:500,message:""},messages:{errorGeneral:"Entschuldigung, es ist ein Fehler aufgetreten. Bitte versuche es erneut.",errorNetwork:"Keine Verbindung zum Server. Bitte pr\xfcfe deine Internetverbindung.",errorTimeout:"Die Anfrage hat zu lange gedauert. Bitte versuche es erneut.",formSubmitted:"âœ“ Gesendet"},colors:{primary:"#6366f1",primaryDark:"#4f46e5",background:"#ffffff",backgroundChat:"#f9fafb",backgroundBotMessage:"#ffffff",textPrimary:"#1f2937",textSecondary:"#6b7280",textOnPrimary:"#ffffff",border:"#e5e7eb",buttonBackground:"#ffffff",buttonBorder:"#6366f1",buttonText:"#6366f1",buttonHoverBackground:"#6366f1",buttonHoverText:"#ffffff",formBorder:"#6366f1",formTitle:"#6366f1",statusOnline:"#22c55e",statusOffline:"#9ca3af"},layout:{position:"right",windowWidth:"420px",windowHeight:"600px",windowBottomOffset:"100px",windowSideOffset:"24px",launcherBottomOffset:"24px",launcherSideOffset:"24px",borderRadius:"16px"},typography:{fontFamily:"'Inter', -apple-system, BlinkMacSystemFont, sans-serif",fontUrl:"https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"},behavior:{autoOpen:!1,autoOpenDelay:3e3,requestTimeout:3e4}},window.ChatWidgetConfig||{});if(!e.webhook.url){console.error("Chat Widget Error: webhook.url is required!");return}if(e.typography.fontUrl){let t=document.createElement("link");t.rel="stylesheet",t.href=e.typography.fontUrl,document.head.appendChild(t)}let r=document.createElement("style");r.textContent=`
        .n8n-chat-widget * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        .n8n-chat-widget {
            --primary: ${e.colors.primary};
            --primary-dark: ${e.colors.primaryDark};
            --bg: ${e.colors.background};
            --bg-chat: ${e.colors.backgroundChat};
            --bg-bot: ${e.colors.backgroundBotMessage};
            --text: ${e.colors.textPrimary};
            --text-secondary: ${e.colors.textSecondary};
            --text-on-primary: ${e.colors.textOnPrimary};
            --border: ${e.colors.border};
            --btn-bg: ${e.colors.buttonBackground};
            --btn-border: ${e.colors.buttonBorder};
            --btn-text: ${e.colors.buttonText};
            --btn-hover-bg: ${e.colors.buttonHoverBackground};
            --btn-hover-text: ${e.colors.buttonHoverText};
            --form-border: ${e.colors.formBorder};
            --form-title: ${e.colors.formTitle};
            --status-online: ${e.colors.statusOnline};
            --radius: ${e.layout.borderRadius};
            --font: ${e.typography.fontFamily};
            font-family: var(--font);
        }

        /* â•â•â•â•â•â•â•â•â•â• CHAT WINDOW â•â•â•â•â•â•â•â•â•â• */
        .n8n-chat-widget .chat-window {
            position: fixed;
            bottom: ${e.layout.windowBottomOffset};
            ${e.layout.position}: ${e.layout.windowSideOffset};
            z-index: 10000;
            width: ${e.layout.windowWidth};
            max-width: calc(100vw - 40px);
            height: ${e.layout.windowHeight};
            max-height: calc(100vh - 140px);
            background: var(--bg);
            border-radius: var(--radius);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);
            display: none;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .n8n-chat-widget .chat-window.open {
            display: flex;
        }

        /* â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â• */
        .n8n-chat-widget .chat-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--text-on-primary);
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }
        .n8n-chat-widget .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: rgba(255,255,255,0.2);
            object-fit: contain;
            padding: 4px;
        }
        .n8n-chat-widget .chat-header-info {
            flex: 1;
        }
        .n8n-chat-widget .chat-header-name {
            font-weight: 600;
            font-size: 15px;
        }
        .n8n-chat-widget .chat-header-status {
            font-size: 12px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .n8n-chat-widget .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--status-online);
        }
        .n8n-chat-widget .chat-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: var(--text-on-primary);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .n8n-chat-widget .chat-close:hover {
            background: rgba(255,255,255,0.3);
        }

        /* â•â•â•â•â•â•â•â•â•â• WELCOME SCREEN â•â•â•â•â•â•â•â•â•â• */
        .n8n-chat-widget .welcome-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 32px;
            text-align: center;
            background: var(--bg-chat);
        }
        .n8n-chat-widget .welcome-screen.hidden {
            display: none;
        }
        .n8n-chat-widget .welcome-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
        }
        .n8n-chat-widget .welcome-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }
        .n8n-chat-widget .welcome-start {
            padding: 14px 28px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--text-on-primary);
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .n8n-chat-widget .welcome-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        .n8n-chat-widget .welcome-start svg {
            width: 20px;
            height: 20px;
        }

        /* â•â•â•â•â•â•â•â•â•â• CHAT BODY â•â•â•â•â•â•â•â•â•â• */
        .n8n-chat-widget .chat-body {
            flex: 1;
            display: none;
            flex-direction: column;
            min-height: 0;
        }
        .n8n-chat-widget .chat-body.active {
            display: flex;
        }

        /* â•â•â•â•â•â•â•â•â•â• MESSAGES â•â•â•â•â•â•â•â•â•â• */
        .n8n-chat-widget .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--bg-chat);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .n8n-chat-widget .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        .n8n-chat-widget .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.1);
            border-radius: 3px;
        }

        /* â•â•â•â•â•â•â•â•â•â• MESSAGE BUBBLES â•â•â•â•â•â•â•â•â•â• */
        .n8n-chat-widget .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
        }
        .n8n-chat-widget .message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--text-on-primary);
            border-bottom-right-radius: 4px;
        }
        .n8n-chat-widget .message.bot {
            align-self: flex-start;
            background: var(--bg-bot);
            color: var(--text);
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .n8n-chat-widget .message.error {
            background: #fef2f2;
            border: 1px solid #ef4444;
            color: #dc2626;
        }
        .n8n-chat-widget .message strong {
            font-weight: 600;
        }
        .n8n-chat-widget .message a {
            color: var(--primary);
            text-decoration: underline;
        }
        .n8n-chat-widget .message.user a {
            color: var(--text-on-primary);
        }

        /* â•â•â•â•â•â•â•â•â•â• QUICK REPLIES â•â•â•â•â•â•â•â•â•â• */
        .n8n-chat-widget .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-self: flex-start;
            max-width: 85%;
        }
        .n8n-chat-widget .quick-reply-btn {
            padding: 10px 18px;
            background: var(--btn-bg);
            border: 2px solid var(--btn-border);
            border-radius: 24px;
            color: var(--btn-text);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        .n8n-chat-widget .quick-reply-btn:hover {
            background: var(--btn-hover-bg);
            color: var(--btn-hover-text);
        }
        .n8n-chat-widget .quick-reply-btn.clicked {
            opacity: 0.5;
            pointer-events: none;
        }

        /* â•â•â•â•â•â•â•â•â•â• ACTION BUTTONS â•â•â•â•â•â•â•â•â•â• */
        .n8n-chat-widget .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-self: flex-start;
            max-width: 85%;
        }
        .n8n-chat-widget .action-btn {
            padding: 12px 16px;
            background: var(--btn-bg);
            border: 2px solid var(--btn-border);
            border-radius: 12px;
            color: var(--btn-text);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            font-family: inherit;
        }
        .n8n-chat-widget .action-btn:hover {
            background: var(--btn-hover-bg);
            color: var(--btn-hover-text);
            transform: translateY(-1px);
        }
        .n8n-chat-widget .action-btn.clicked {
            opacity: 0.5;
            pointer-events: none;
        }

        /* â•â•â•â•â•â•â•â•â•â• DYNAMIC FORM â•â•â•â•â•â•â•â•â•â• */
        .n8n-chat-widget .dynamic-form {
            align-self: flex-start;
            width: 100%;
            max-width: 100%;
            background: var(--bg);
            border: 2px solid var(--form-border);
            border-radius: 12px;
            padding: 16px;
        }
        .n8n-chat-widget .form-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--form-title);
            margin-bottom: 16px;
            text-align: center;
        }
        .n8n-chat-widget .form-grid {
            display: grid;
            gap: 12px;
        }
        .n8n-chat-widget .form-grid.cols-2 {
            grid-template-columns: repeat(2, 1fr);
        }
        @media (max-width: 500px) {
            .n8n-chat-widget .form-grid.cols-2 {
                grid-template-columns: 1fr;
            }
        }
        .n8n-chat-widget .form-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .n8n-chat-widget .form-field.full-width {
            grid-column: 1 / -1;
        }
        .n8n-chat-widget .form-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text);
        }
        .n8n-chat-widget .form-label.required::after {
            content: ' *';
            color: #ef4444;
        }
        .n8n-chat-widget .form-input,
        .n8n-chat-widget .form-select,
        .n8n-chat-widget .form-textarea {
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: var(--bg);
            color: var(--text);
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .n8n-chat-widget .form-input:focus,
        .n8n-chat-widget .form-select:focus,
        .n8n-chat-widget .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        .n8n-chat-widget .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        .n8n-chat-widget .option-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .n8n-chat-widget .option-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .n8n-chat-widget .option-item input {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }
        .n8n-chat-widget .option-item span {
            font-size: 14px;
            color: var(--text);
        }
        .n8n-chat-widget .range-container {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .n8n-chat-widget .range-input {
            width: 100%;
            accent-color: var(--primary);
        }
        .n8n-chat-widget .range-value {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
        }
        .n8n-chat-widget .form-submit {
            margin-top: 16px;
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--text-on-primary);
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            display: block;
            width: auto;
            min-width: 120px;
            margin-left: auto;
            margin-right: auto;
            transition: transform 0.2s;
        }
        .n8n-chat-widget .form-submit:hover {
            transform: translateY(-1px);
        }
        .n8n-chat-widget .form-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .n8n-chat-widget .dynamic-form.submitted {
            opacity: 0.7;
            pointer-events: none;
        }

        /* â•â•â•â•â•â•â•â•â•â• TYPING INDICATOR â•â•â•â•â•â•â•â•â•â• */
        .n8n-chat-widget .typing {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: var(--bg-bot);
            border-radius: 16px;
            border-bottom-left-radius: 4px;
            align-self: flex-start;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .n8n-chat-widget .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            animation: n8nTyping 1.4s infinite ease-in-out;
        }
        .n8n-chat-widget .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .n8n-chat-widget .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes n8nTyping {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }

        /* â•â•â•â•â•â•â•â•â•â• INPUT AREA â•â•â•â•â•â•â•â•â•â• */
        .n8n-chat-widget .chat-input-area {
            padding: 16px;
            background: var(--bg);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }
        .n8n-chat-widget .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 24px;
            background: var(--bg);
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
            resize: none;
            max-height: 100px;
            min-height: 44px;
            line-height: 1.4;
        }
        .n8n-chat-widget .chat-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        .n8n-chat-widget .chat-input::placeholder {
            color: var(--text-secondary);
        }
        .n8n-chat-widget .chat-send {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            border-radius: 50%;
            color: var(--text-on-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: transform 0.2s;
        }
        .n8n-chat-widget .chat-send:hover {
            transform: scale(1.05);
        }
        .n8n-chat-widget .chat-send svg {
            width: 20px;
            height: 20px;
        }

        /* â•â•â•â•â•â•â•â•â•â• FOOTER â•â•â•â•â•â•â•â•â•â• */
        .n8n-chat-widget .chat-footer {
            padding: 10px;
            text-align: center;
            background: var(--bg);
            border-top: 1px solid var(--border);
            flex-shrink: 0;
        }
        .n8n-chat-widget .chat-footer.hidden {
            display: none;
        }
        .n8n-chat-widget .chat-footer a {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 11px;
        }
        .n8n-chat-widget .chat-footer a:hover {
            color: var(--primary);
        }

        /* â•â•â•â•â•â•â•â•â•â• LAUNCHER â•â•â•â•â•â•â•â•â•â• */
        .n8n-chat-widget .chat-launcher {
            position: fixed;
            bottom: ${e.layout.launcherBottomOffset};
            ${e.layout.position}: ${e.layout.launcherSideOffset};
            z-index: 9999;
            height: 56px;
            padding: 0 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--text-on-primary);
            border: none;
            border-radius: 28px;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: inherit;
            font-weight: 600;
            font-size: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .n8n-chat-widget .chat-launcher:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }
        .n8n-chat-widget .chat-launcher svg {
            width: 24px;
            height: 24px;
        }
    `,document.head.appendChild(r);let a="",n=!1,o=document.createElement("div");o.className="n8n-chat-widget";let i=e.branding.showBotAvatar&&e.branding.botAvatar?`<img class="chat-avatar" src="${e.branding.botAvatar}" alt="${e.branding.botName}">`:"",l=e.branding.showFooter?"":" hidden";o.innerHTML=`
        <div class="chat-window">
            <div class="chat-header">
                ${i}
                <div class="chat-header-info">
                    <div class="chat-header-name">${e.branding.botName}</div>
                    <div class="chat-header-status">
                        <span class="status-dot"></span>
                        ${e.branding.botStatus}
                    </div>
                </div>
                <button class="chat-close">\xd7</button>
            </div>
            
            <div class="welcome-screen">
                <div class="welcome-title">${e.branding.welcomeTitle}</div>
                <div class="welcome-subtitle">${e.branding.welcomeSubtitle}</div>
                <button class="welcome-start">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    ${e.branding.welcomeButtonText}
                </button>
            </div>
            
            <div class="chat-body">
                <div class="chat-messages"></div>
                <div class="chat-input-area">
                    <textarea class="chat-input" placeholder="${e.branding.inputPlaceholder}" rows="1"></textarea>
                    <button class="chat-send">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 2L11 13"></path>
                            <path d="M22 2l-7 20-4-9-9-4 20-7z"></path>
                        </svg>
                    </button>
                </div>
                <div class="chat-footer${l}">
                    <a href="${e.branding.footerLink}" target="_blank">${e.branding.footerText}</a>
                </div>
            </div>
        </div>
        
        <button class="chat-launcher">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
            </svg>
            <span>${e.branding.launcherText}</span>
        </button>
    `,document.body.appendChild(o);let d=o.querySelector(".chat-window"),s=o.querySelector(".welcome-screen"),c=o.querySelector(".chat-body"),p=o.querySelector(".chat-messages"),h=o.querySelector(".chat-input"),g=o.querySelector(".chat-send"),u=o.querySelector(".chat-launcher"),f=o.querySelector(".chat-close"),m=o.querySelector(".welcome-start");function b(e){let t=e,r=[],a=[],n=null,o=/\{([^}]+)\}/g,i;for(;null!==(i=o.exec(e));){let l=i[1].split("|").map(e=>e.trim()).filter(e=>e);r.push(...l)}t=t.replace(o,"");let d=/\[([^\]]+)\]\s*=\s*\[([^\]]+)\]/g,s;for(;null!==(s=d.exec(e));)a.push({label:s[1].trim(),value:s[2].trim()});t=t.replace(d,"");let c=/\[FORM\]([\s\S]*?)\[\/FORM\]/i,p=e.match(c);if(p)try{n=JSON.parse(p[1].trim())}catch(h){console.error("Invalid form JSON:",h)}return{text:t=(t=t.replace(c,"")).replace(/\n{3,}/g,"\n\n").trim(),quickReplies:r,actionButtons:a,form:n}}function x(e,t=!1,r=!1){var a;let n=document.createElement("div");n.className=`message ${t?"user":"bot"}${r?" error":""}`,n.innerHTML=(a=e).replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/\n/g,"<br>").replace(/(https?:\/\/[^\s<]+)/g,'<a href="$1" target="_blank">$1</a>'),p.appendChild(n),p.scrollTop=p.scrollHeight}function w(e){if(!e.length)return;let t=document.createElement("div");t.className="quick-replies",e.forEach(e=>{let r=document.createElement("button");r.className="quick-reply-btn",r.textContent=e,r.onclick=()=>{t.querySelectorAll(".quick-reply-btn").forEach(e=>e.classList.add("clicked")),y(e)},t.appendChild(r)}),p.appendChild(t),p.scrollTop=p.scrollHeight}function $(e){if(!e.length)return;let t=document.createElement("div");t.className="action-buttons",e.forEach(e=>{let r=document.createElement("button");r.className="action-btn",r.textContent=e.label,r.onclick=()=>{t.querySelectorAll(".action-btn").forEach(e=>e.classList.add("clicked")),y(e.value)},t.appendChild(r)}),p.appendChild(t),p.scrollTop=p.scrollHeight}function v(t){if(!t)return;let r=document.createElement("div");r.className="dynamic-form";let a=t.columns||1,n=t.title?`<div class="form-title">${t.title}</div>`:"";n+=`<form class="form-grid ${2===a?"cols-2":""}">`,t.fields.forEach(e=>{let t=e.fullWidth||["textarea","radio","checkbox"].includes(e.type),r=e.required?"required":"";switch(n+=`<div class="form-field ${t?"full-width":""}">`,n+=`<label class="form-label ${r}">${e.label}</label>`,e.type){case"select":n+=`<select class="form-select" name="${e.name}" ${e.required?"required":""}>`,n+=`<option value="">${e.placeholder||"Bitte w\xe4hlen..."}</option>`,(e.options||[]).forEach(e=>{n+=`<option value="${e}">${e}</option>`}),n+="</select>";break;case"textarea":n+=`<textarea class="form-textarea" name="${e.name}" placeholder="${e.placeholder||""}" rows="${e.rows||3}" ${e.required?"required":""}></textarea>`;break;case"radio":n+='<div class="option-group">',(e.options||[]).forEach((t,r)=>{n+=`<label class="option-item"><input type="radio" name="${e.name}" value="${t}" ${e.required&&0===r?"required":""}><span>${t}</span></label>`}),n+="</div>";break;case"checkbox":n+='<div class="option-group">',(e.options||[]).forEach(t=>{n+=`<label class="option-item"><input type="checkbox" name="${e.name}" value="${t}"><span>${t}</span></label>`}),n+="</div>";break;case"range":let a=e.min||0,o=e.max||100,i=e.default||Math.round((a+o)/2);n+='<div class="range-container">',n+=`<input type="range" class="range-input" name="${e.name}" min="${a}" max="${o}" value="${i}">`,n+=`<div class="range-value">${i}</div>`,n+="</div>";break;default:n+=`<input class="form-input" type="${e.type||"text"}" name="${e.name}" placeholder="${e.placeholder||""}" ${e.required?"required":""}>`}n+="</div>"}),n+=`<button type="submit" class="form-submit">${t.submitText||"Absenden"}</button>`,n+="</form>",r.innerHTML=n,r.querySelectorAll(".range-input").forEach(e=>{e.addEventListener("input",e=>{e.target.parentElement.querySelector(".range-value").textContent=e.target.value})}),r.querySelector("form").addEventListener("submit",a=>{a.preventDefault();let n=new FormData(a.target),o={};for(let[i,l]of(r.querySelectorAll('input[type="checkbox"]').forEach(e=>{o[e.name]||(o[e.name]=[])}),n.entries())){let d=t.fields.find(e=>e.name===i);d&&"checkbox"===d.type?(o[i]||(o[i]=[]),o[i].push(l)):o[i]=l}Object.keys(o).forEach(e=>{Array.isArray(o[e])&&(o[e]=o[e].join(", "))}),r.classList.add("submitted"),r.querySelector(".form-submit").textContent=e.messages.formSubmitted;let s=t.title?`ğŸ“‹ **${t.title}**

`:"\uD83D\uDCCB **Formulardaten:**\n\n";t.fields.forEach(e=>{o[e.name]&&(s+=`**${e.label}:** ${o[e.name]}
`)}),y(s.trim())}),p.appendChild(r),p.scrollTop=p.scrollHeight}async function y(t){if(n||!t.trim())return;n=!0,x(t,!0);let r=function e(){let t=document.createElement("div");return t.className="typing",t.innerHTML='<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>',p.appendChild(t),p.scrollTop=p.scrollHeight,t}(),o=new AbortController,i=setTimeout(()=>o.abort(),e.behavior.requestTimeout);try{let l=await fetch(e.webhook.url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"sendMessage",sessionId:a,route:e.webhook.route,chatInput:t}),signal:o.signal});if(clearTimeout(i),r.remove(),!l.ok)throw Error("HTTP "+l.status);let d=await l.json(),s=Array.isArray(d)?d[0].output:d.output,c=b(s);c.text&&x(c.text),c.quickReplies.length&&w(c.quickReplies),c.actionButtons.length&&$(c.actionButtons),c.form&&v(c.form)}catch(h){clearTimeout(i),r.remove();let g=e.messages.errorGeneral;"AbortError"===h.name?g=e.messages.errorTimeout:h.message.includes("fetch")&&(g=e.messages.errorNetwork),x(g,!1,!0),console.error("Chat error:",h)}n=!1}u.addEventListener("click",()=>{d.classList.toggle("open")}),f.addEventListener("click",()=>{d.classList.remove("open")}),m.addEventListener("click",function t(){a="sess_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),s.classList.add("hidden"),c.classList.add("active"),e.initialMessage.enabled&&e.initialMessage.message&&setTimeout(()=>{let t=b(e.initialMessage.message);t.text&&x(t.text),t.quickReplies.length&&w(t.quickReplies),t.actionButtons.length&&$(t.actionButtons),t.form&&v(t.form)},e.initialMessage.delay)}),g.addEventListener("click",()=>{y(h.value),h.value="",h.style.height="auto"}),h.addEventListener("keypress",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),y(h.value),h.value="",h.style.height="auto")}),h.addEventListener("input",()=>{h.style.height="auto",h.style.height=Math.min(h.scrollHeight,100)+"px"}),e.behavior.autoOpen&&setTimeout(()=>{d.classList.add("open")},e.behavior.autoOpenDelay)}();
