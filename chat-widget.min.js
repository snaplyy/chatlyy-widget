(function(){if(window.N8nChatWidgetLoaded)return;window.N8nChatWidgetLoaded=true;const defaultConfig={webhook:{url:"",route:"general"},branding:{botName:"Ben",botStatus:"Online",botAvatar:"",showBotAvatar:true,welcomeTitle:"Hallo, ich bin Ben üëã",welcomeSubtitle:"Ihr pers√∂nlicher KI-Steuerbot von Onlinesteuern.de",welcomeQuestion:"Wie kann ich Ihnen helfen?",welcomeButtonText:"Chat starten",inputPlaceholder:"Nachricht senden",launcherIcon:"chat",footerText:"",footerLink:"",showFooter:false},portalButton:{enabled:true,text:"Zum Mandantenportal",actionText:"√ñffnen",url:"https://ben.onlinesteuern.de",openInNewTab:true},initialMessage:{enabled:true,delay:500,message:""},messages:{errorTitle:"Konnte nicht antworten",errorGeneral:"Server error",errorNetwork:"Keine Verbindung zum Server",errorTimeout:"Zeit√ºberschreitung",errorRetry:"Erneut versuchen",formSubmitted:"‚úì Gesendet"},colors:{primary:"#1a8a7d",primaryDark:"#15756a",background:"#ffffff",backgroundChat:"#f0f2f5",backgroundBotMessage:"#ffffff",textPrimary:"#1f2937",textSecondary:"#6b7280",textOnPrimary:"#ffffff",border:"#e5e7eb",buttonBackground:"#ffffff",buttonBorder:"#1a8a7d",buttonText:"#1a8a7d",buttonHoverBackground:"#1a8a7d",buttonHoverText:"#ffffff",formBorder:"#1a8a7d",formTitle:"#1a8a7d",statusOnline:"#22c55e",statusOffline:"#9ca3af",errorBackground:"#fff3cd",errorText:"#d63031",errorSubtext:"#856404"},layout:{position:"right",windowWidth:"420px",windowHeight:"600px",windowBottomOffset:"100px",windowSideOffset:"24px",launcherBottomOffset:"24px",launcherSideOffset:"24px",borderRadius:"16px"},typography:{fontFamily:"'Inter', -apple-system, BlinkMacSystemFont, sans-serif",fontUrl:"https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"},behavior:{autoOpen:false,autoOpenDelay:3e3,requestTimeout:3e4}};function deepMerge(target,source){const result={...target};for(const key in source){if(source[key]&&typeof source[key]==="object"&&!Array.isArray(source[key])){result[key]=deepMerge(target[key]||{},source[key])}else if(source[key]!==undefined&&source[key]!==""){result[key]=source[key]}}return result}const config=deepMerge(defaultConfig,window.ChatWidgetConfig||{});if(!config.webhook.url){console.error("Chat Widget Error: webhook.url is required!");return}if(config.typography.fontUrl){const fontLink=document.createElement("link");fontLink.rel="stylesheet";fontLink.href=config.typography.fontUrl;document.head.appendChild(fontLink)}const styles=document.createElement("style");styles.textContent=`\n        .n8n-chat-widget * {\n            box-sizing: border-box;\n            margin: 0;\n            padding: 0;\n        }\n        .n8n-chat-widget {\n            --primary: ${config.colors.primary};\n            --primary-dark: ${config.colors.primaryDark};\n            --bg: ${config.colors.background};\n            --bg-chat: ${config.colors.backgroundChat};\n            --bg-bot: ${config.colors.backgroundBotMessage};\n            --text: ${config.colors.textPrimary};\n            --text-secondary: ${config.colors.textSecondary};\n            --text-on-primary: ${config.colors.textOnPrimary};\n            --border: ${config.colors.border};\n            --btn-bg: ${config.colors.buttonBackground};\n            --btn-border: ${config.colors.buttonBorder};\n            --btn-text: ${config.colors.buttonText};\n            --btn-hover-bg: ${config.colors.buttonHoverBackground};\n            --btn-hover-text: ${config.colors.buttonHoverText};\n            --form-border: ${config.colors.formBorder};\n            --form-title: ${config.colors.formTitle};\n            --status-online: ${config.colors.statusOnline};\n            --error-bg: ${config.colors.errorBackground};\n            --error-text: ${config.colors.errorText};\n            --error-subtext: ${config.colors.errorSubtext};\n            --radius: ${config.layout.borderRadius};\n            --font: ${config.typography.fontFamily};\n            font-family: var(--font);\n        }\n\n        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CHAT WINDOW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */\n        .n8n-chat-widget .chat-window {\n            position: fixed;\n            bottom: ${config.layout.windowBottomOffset};\n            ${config.layout.position}: ${config.layout.windowSideOffset};\n            z-index: 10000;\n            width: ${config.layout.windowWidth};\n            max-width: calc(100vw - 40px);\n            height: ${config.layout.windowHeight};\n            max-height: calc(100vh - 140px);\n            background: var(--bg);\n            border-radius: var(--radius);\n            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);\n            display: none;\n            flex-direction: column;\n            overflow: hidden;\n            transition: all 0.3s ease;\n        }\n        .n8n-chat-widget .chat-window.open {\n            display: flex;\n        }\n\n        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */\n        .n8n-chat-widget .chat-header {\n            padding: 16px 20px;\n            background: linear-gradient(135deg, var(--primary), var(--primary-dark));\n            color: var(--text-on-primary);\n            display: flex;\n            align-items: center;\n            gap: 12px;\n            flex-shrink: 0;\n        }\n        .n8n-chat-widget .chat-avatar {\n            width: 40px;\n            height: 40px;\n            border-radius: 50%;\n            background: rgba(255,255,255,0.2);\n            object-fit: cover;\n            border: 2px solid rgba(255,255,255,0.3);\n        }\n        .n8n-chat-widget .chat-header-info {\n            flex: 1;\n        }\n        .n8n-chat-widget .chat-header-name {\n            font-weight: 600;\n            font-size: 15px;\n        }\n        .n8n-chat-widget .chat-header-status {\n            font-size: 12px;\n            opacity: 0.9;\n            display: flex;\n            align-items: center;\n            gap: 6px;\n        }\n        .n8n-chat-widget .status-dot {\n            width: 8px;\n            height: 8px;\n            border-radius: 50%;\n            background: var(--status-online);\n        }\n        .n8n-chat-widget .chat-close {\n            background: rgba(255,255,255,0.2);\n            border: none;\n            color: var(--text-on-primary);\n            width: 32px;\n            height: 32px;\n            border-radius: 8px;\n            cursor: pointer;\n            font-size: 20px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            transition: background 0.2s;\n        }\n        .n8n-chat-widget .chat-close:hover {\n            background: rgba(255,255,255,0.3);\n        }\n\n        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WELCOME SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */\n        .n8n-chat-widget .welcome-screen {\n            flex: 1;\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            justify-content: center;\n            padding: 32px;\n            text-align: center;\n            background: var(--bg-chat);\n        }\n        .n8n-chat-widget .welcome-screen.hidden {\n            display: none;\n        }\n        .n8n-chat-widget .welcome-avatar {\n            width: 90px;\n            height: 90px;\n            border-radius: 50%;\n            object-fit: cover;\n            margin-bottom: 16px;\n            box-shadow: 0 4px 12px rgba(0,0,0,0.12);\n            border: 3px solid var(--bg);\n        }\n        .n8n-chat-widget .welcome-title {\n            font-size: 20px;\n            font-weight: 600;\n            color: var(--text);\n            margin-bottom: 4px;\n        }\n        .n8n-chat-widget .welcome-subtitle {\n            font-size: 14px;\n            color: var(--text-secondary);\n            margin-bottom: 6px;\n        }\n        .n8n-chat-widget .welcome-subtitle-small {\n            font-size: 14px;\n            color: var(--text-secondary);\n            margin-bottom: 24px;\n        }\n        .n8n-chat-widget .welcome-start {\n            padding: 14px 28px;\n            background: linear-gradient(135deg, var(--primary), var(--primary-dark));\n            color: var(--text-on-primary);\n            border: none;\n            border-radius: 12px;\n            font-size: 15px;\n            font-weight: 600;\n            cursor: pointer;\n            font-family: inherit;\n            display: flex;\n            align-items: center;\n            gap: 8px;\n            transition: transform 0.2s, box-shadow 0.2s;\n        }\n        .n8n-chat-widget .welcome-start:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 4px 12px rgba(26, 138, 125, 0.4);\n        }\n        .n8n-chat-widget .welcome-portal {\n            margin-top: 12px;\n            padding: 12px 28px;\n            background: var(--bg);\n            color: var(--primary);\n            border: 1.5px solid var(--primary);\n            border-radius: 12px;\n            font-size: 14px;\n            font-weight: 600;\n            cursor: pointer;\n            font-family: inherit;\n            display: flex;\n            align-items: center;\n            gap: 8px;\n            text-decoration: none;\n            transition: all 0.2s;\n        }\n        .n8n-chat-widget .welcome-portal:hover {\n            background: var(--primary);\n            color: var(--text-on-primary);\n            transform: translateY(-2px);\n            box-shadow: 0 4px 12px rgba(26, 138, 125, 0.3);\n        }\n        .n8n-chat-widget .welcome-portal svg {\n            width: 16px;\n            height: 16px;\n        }\n        .n8n-chat-widget .welcome-portal.hidden {\n            display: none;\n        }\n        .n8n-chat-widget .welcome-start svg {\n            width: 20px;\n            height: 20px;\n        }\n\n        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CHAT BODY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */\n        .n8n-chat-widget .chat-body {\n            flex: 1;\n            display: none;\n            flex-direction: column;\n            min-height: 0;\n        }\n        .n8n-chat-widget .chat-body.active {\n            display: flex;\n        }\n\n        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MESSAGES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */\n        .n8n-chat-widget .chat-messages {\n            flex: 1;\n            overflow-y: auto;\n            padding: 20px;\n            background: var(--bg-chat);\n            display: flex;\n            flex-direction: column;\n            gap: 12px;\n        }\n        .n8n-chat-widget .chat-messages::-webkit-scrollbar {\n            width: 6px;\n        }\n        .n8n-chat-widget .chat-messages::-webkit-scrollbar-thumb {\n            background: rgba(0,0,0,0.1);\n            border-radius: 3px;\n        }\n\n        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MESSAGE BUBBLES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */\n        .n8n-chat-widget .message {\n            max-width: 85%;\n            padding: 12px 16px;\n            border-radius: 16px;\n            font-size: 14px;\n            line-height: 1.5;\n            word-wrap: break-word;\n        }\n        .n8n-chat-widget .message.user {\n            align-self: flex-end;\n            background: linear-gradient(135deg, var(--primary), var(--primary-dark));\n            color: var(--text-on-primary);\n            border-bottom-right-radius: 4px;\n        }\n        .n8n-chat-widget .message.bot {\n            align-self: flex-start;\n            background: var(--bg-bot);\n            color: var(--text);\n            border-bottom-left-radius: 4px;\n            box-shadow: 0 1px 2px rgba(0,0,0,0.05);\n        }\n        .n8n-chat-widget .message.error {\n            background: var(--error-bg);\n            border: none;\n            color: var(--text);\n            border-radius: 16px;\n            border-bottom-left-radius: 4px;\n            box-shadow: 0 1px 2px rgba(0,0,0,0.05);\n        }\n        .n8n-chat-widget .message.error .error-title {\n            font-weight: 600;\n            color: var(--error-text);\n            margin-bottom: 2px;\n        }\n        .n8n-chat-widget .message.error .error-detail {\n            color: var(--error-subtext);\n            font-size: 13px;\n        }\n        .n8n-chat-widget .message.error .error-retry {\n            color: var(--primary);\n            text-decoration: underline;\n            cursor: pointer;\n            font-size: 13px;\n            margin-top: 4px;\n            display: inline-block;\n        }\n        .n8n-chat-widget .message.error .error-retry:hover {\n            color: var(--primary-dark);\n        }\n        .n8n-chat-widget .message strong {\n            font-weight: 600;\n        }\n        .n8n-chat-widget .message a {\n            color: var(--primary);\n            text-decoration: underline;\n        }\n        .n8n-chat-widget .message.user a {\n            color: var(--text-on-primary);\n        }\n\n        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SHARED BUTTON STYLE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */\n        .n8n-chat-widget .quick-reply-btn,\n        .n8n-chat-widget .action-btn {\n            padding: 10px 18px;\n            background: var(--bg);\n            border: 1.5px solid var(--border);\n            border-radius: 10px;\n            color: var(--text);\n            font-size: 14px;\n            font-weight: 500;\n            cursor: pointer;\n            transition: all 0.2s ease;\n            font-family: inherit;\n            box-shadow: 0 1px 3px rgba(0,0,0,0.06);\n        }\n        .n8n-chat-widget .quick-reply-btn:hover,\n        .n8n-chat-widget .action-btn:hover {\n            background: var(--primary);\n            color: var(--text-on-primary);\n            border-color: var(--primary);\n            box-shadow: 0 2px 8px rgba(26, 138, 125, 0.25);\n            transform: translateY(-1px);\n        }\n        .n8n-chat-widget .quick-reply-btn:active,\n        .n8n-chat-widget .action-btn:active {\n            transform: translateY(0);\n            box-shadow: 0 1px 2px rgba(0,0,0,0.08);\n        }\n        .n8n-chat-widget .quick-reply-btn.clicked,\n        .n8n-chat-widget .action-btn.clicked {\n            opacity: 0.5;\n            pointer-events: none;\n        }\n\n        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê QUICK REPLIES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */\n        .n8n-chat-widget .quick-replies {\n            display: flex;\n            flex-wrap: wrap;\n            gap: 8px;\n            align-self: flex-start;\n            max-width: 85%;\n        }\n\n        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ACTION BUTTONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */\n        .n8n-chat-widget .action-buttons {\n            display: flex;\n            flex-direction: column;\n            gap: 8px;\n            align-self: flex-start;\n            max-width: 85%;\n        }\n        .n8n-chat-widget .action-btn {\n            text-align: left;\n        }\n\n        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DYNAMIC FORM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */\n        .n8n-chat-widget .dynamic-form {\n            align-self: flex-start;\n            width: 100%;\n            max-width: 100%;\n            background: var(--bg);\n            border: 2px solid var(--form-border);\n            border-radius: 12px;\n            padding: 16px;\n        }\n        .n8n-chat-widget .form-title {\n            font-size: 15px;\n            font-weight: 600;\n            color: var(--form-title);\n            margin-bottom: 16px;\n            text-align: center;\n        }\n        .n8n-chat-widget .form-grid {\n            display: grid;\n            gap: 12px;\n        }\n        .n8n-chat-widget .form-grid.cols-2 {\n            grid-template-columns: repeat(2, 1fr);\n        }\n        @media (max-width: 500px) {\n            .n8n-chat-widget .form-grid.cols-2 {\n                grid-template-columns: 1fr;\n            }\n        }\n        .n8n-chat-widget .form-field {\n            display: flex;\n            flex-direction: column;\n            gap: 4px;\n        }\n        .n8n-chat-widget .form-field.full-width {\n            grid-column: 1 / -1;\n        }\n        .n8n-chat-widget .form-label {\n            font-size: 12px;\n            font-weight: 500;\n            color: var(--text);\n        }\n        .n8n-chat-widget .form-label.required::after {\n            content: ' *';\n            color: #ef4444;\n        }\n        .n8n-chat-widget .form-input,\n        .n8n-chat-widget .form-select,\n        .n8n-chat-widget .form-textarea {\n            padding: 10px 12px;\n            border: 1px solid var(--border);\n            border-radius: 8px;\n            font-size: 14px;\n            font-family: inherit;\n            background: var(--bg);\n            color: var(--text);\n            width: 100%;\n            transition: border-color 0.2s, box-shadow 0.2s;\n        }\n        .n8n-chat-widget .form-input:focus,\n        .n8n-chat-widget .form-select:focus,\n        .n8n-chat-widget .form-textarea:focus {\n            outline: none;\n            border-color: var(--primary);\n            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);\n        }\n        .n8n-chat-widget .form-textarea {\n            resize: vertical;\n            min-height: 80px;\n        }\n        .n8n-chat-widget .option-group {\n            display: flex;\n            flex-direction: column;\n            gap: 8px;\n        }\n        .n8n-chat-widget .option-item {\n            display: flex;\n            align-items: center;\n            gap: 8px;\n            cursor: pointer;\n        }\n        .n8n-chat-widget .option-item input {\n            width: 18px;\n            height: 18px;\n            accent-color: var(--primary);\n        }\n        .n8n-chat-widget .option-item span {\n            font-size: 14px;\n            color: var(--text);\n        }\n        .n8n-chat-widget .range-container {\n            display: flex;\n            flex-direction: column;\n            gap: 4px;\n        }\n        .n8n-chat-widget .range-input {\n            width: 100%;\n            accent-color: var(--primary);\n        }\n        .n8n-chat-widget .range-value {\n            font-size: 12px;\n            color: var(--text-secondary);\n            text-align: center;\n        }\n        .n8n-chat-widget .form-submit {\n            margin-top: 16px;\n            padding: 12px 24px;\n            background: linear-gradient(135deg, var(--primary), var(--primary-dark));\n            color: var(--text-on-primary);\n            border: none;\n            border-radius: 10px;\n            font-size: 14px;\n            font-weight: 600;\n            cursor: pointer;\n            font-family: inherit;\n            display: block;\n            width: auto;\n            min-width: 120px;\n            margin-left: auto;\n            margin-right: auto;\n            transition: transform 0.2s;\n        }\n        .n8n-chat-widget .form-submit:hover {\n            transform: translateY(-1px);\n        }\n        .n8n-chat-widget .form-submit:disabled {\n            opacity: 0.6;\n            cursor: not-allowed;\n            transform: none;\n        }\n        .n8n-chat-widget .dynamic-form.submitted {\n            opacity: 0.7;\n            pointer-events: none;\n        }\n\n        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TYPING INDICATOR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */\n        .n8n-chat-widget .typing {\n            display: flex;\n            gap: 4px;\n            padding: 12px 16px;\n            background: var(--bg-bot);\n            border-radius: 16px;\n            border-bottom-left-radius: 4px;\n            align-self: flex-start;\n            box-shadow: 0 1px 2px rgba(0,0,0,0.05);\n        }\n        .n8n-chat-widget .typing-dot {\n            width: 8px;\n            height: 8px;\n            background: var(--primary);\n            border-radius: 50%;\n            animation: n8nTyping 1.4s infinite ease-in-out;\n        }\n        .n8n-chat-widget .typing-dot:nth-child(2) { animation-delay: 0.2s; }\n        .n8n-chat-widget .typing-dot:nth-child(3) { animation-delay: 0.4s; }\n        @keyframes n8nTyping {\n            0%, 60%, 100% { transform: translateY(0); }\n            30% { transform: translateY(-4px); }\n        }\n\n        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INPUT AREA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */\n        .n8n-chat-widget .chat-input-area {\n            padding: 16px;\n            background: var(--bg);\n            border-top: 1px solid var(--border);\n            display: flex;\n            gap: 10px;\n            flex-shrink: 0;\n        }\n        .n8n-chat-widget .chat-input {\n            flex: 1;\n            padding: 12px 16px;\n            border: 1px solid var(--border);\n            border-radius: 24px;\n            background: var(--bg);\n            color: var(--text);\n            font-size: 14px;\n            font-family: inherit;\n            resize: none;\n            overflow: hidden;\n            max-height: 100px;\n            min-height: 44px;\n            line-height: 1.4;\n        }\n        .n8n-chat-widget .chat-input:focus {\n            outline: none;\n            border-color: var(--primary);\n        }\n        .n8n-chat-widget .chat-input::placeholder {\n            color: var(--text-secondary);\n        }\n        .n8n-chat-widget .chat-send {\n            width: 44px;\n            height: 44px;\n            background: linear-gradient(135deg, var(--primary), var(--primary-dark));\n            border: none;\n            border-radius: 50%;\n            color: var(--text-on-primary);\n            cursor: pointer;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            flex-shrink: 0;\n            transition: transform 0.2s;\n        }\n        .n8n-chat-widget .chat-send:hover {\n            transform: scale(1.05);\n        }\n        .n8n-chat-widget .chat-send svg {\n            width: 20px;\n            height: 20px;\n        }\n\n        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FOOTER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */\n        .n8n-chat-widget .chat-footer {\n            padding: 10px;\n            text-align: center;\n            background: var(--bg);\n            border-top: 1px solid var(--border);\n            flex-shrink: 0;\n        }\n        .n8n-chat-widget .chat-footer.hidden {\n            display: none;\n        }\n        .n8n-chat-widget .chat-footer a {\n            color: var(--text-secondary);\n            text-decoration: none;\n            font-size: 11px;\n        }\n        .n8n-chat-widget .chat-footer a:hover {\n            color: var(--primary);\n        }\n\n        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PORTAL BUTTON ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */\n        .n8n-chat-widget .portal-button {\n            display: flex;\n            align-items: center;\n            justify-content: space-between;\n            padding: 14px 20px;\n            background: var(--primary);\n            color: var(--text-on-primary);\n            border: none;\n            cursor: pointer;\n            font-family: inherit;\n            font-size: 14px;\n            font-weight: 600;\n            flex-shrink: 0;\n            transition: background 0.2s;\n            text-decoration: none;\n            border-radius: 0 0 var(--radius) var(--radius);\n        }\n        .n8n-chat-widget .portal-button:hover {\n            background: var(--primary-dark);\n        }\n        .n8n-chat-widget .portal-button .portal-label {\n            display: flex;\n            align-items: center;\n            gap: 8px;\n        }\n        .n8n-chat-widget .portal-button .portal-action {\n            display: flex;\n            align-items: center;\n            gap: 6px;\n            font-weight: 500;\n            font-size: 13px;\n            opacity: 0.9;\n        }\n        .n8n-chat-widget .portal-button .portal-action svg {\n            width: 16px;\n            height: 16px;\n        }\n        .n8n-chat-widget .portal-button.hidden {\n            display: none;\n        }\n\n        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TIMESTAMP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */\n        .n8n-chat-widget .message-time {\n            font-size: 11px;\n            color: var(--text-secondary);\n            margin-top: 4px;\n            align-self: flex-start;\n        }\n        .n8n-chat-widget .message-time.user-time {\n            align-self: flex-end;\n        }\n\n        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BOT AVATAR IN MESSAGES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */\n        .n8n-chat-widget .message-row {\n            display: flex;\n            align-items: flex-end;\n            gap: 8px;\n            max-width: 85%;\n        }\n        .n8n-chat-widget .message-row.bot-row {\n            align-self: flex-start;\n        }\n        .n8n-chat-widget .message-row.user-row {\n            align-self: flex-end;\n            flex-direction: row-reverse;\n        }\n        .n8n-chat-widget .message-row .msg-avatar {\n            width: 28px;\n            height: 28px;\n            border-radius: 50%;\n            background: var(--primary);\n            flex-shrink: 0;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n        }\n        .n8n-chat-widget .message-row .msg-avatar img {\n            width: 28px;\n            height: 28px;\n            border-radius: 50%;\n            object-fit: cover;\n        }\n        .n8n-chat-widget .message-row .msg-avatar-placeholder {\n            width: 28px;\n            height: 28px;\n            border-radius: 50%;\n            background: transparent;\n            flex-shrink: 0;\n        }\n\n        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LAUNCHER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */\n        .n8n-chat-widget .chat-launcher {\n            position: fixed;\n            bottom: ${config.layout.launcherBottomOffset};\n            ${config.layout.position}: ${config.layout.launcherSideOffset};\n            z-index: 9999;\n            width: 56px;\n            height: 56px;\n            padding: 0;\n            background: linear-gradient(135deg, var(--primary), var(--primary-dark));\n            color: var(--text-on-primary);\n            border: none;\n            border-radius: 50%;\n            cursor: pointer;\n            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            font-family: inherit;\n            transition: transform 0.2s, box-shadow 0.2s;\n        }\n        .n8n-chat-widget .chat-launcher:hover {\n            transform: scale(1.05);\n            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);\n        }\n        .n8n-chat-widget .chat-launcher svg {\n            width: 24px;\n            height: 24px;\n        }\n        .n8n-chat-widget .chat-launcher .launcher-icon-close {\n            display: none;\n        }\n        .n8n-chat-widget .chat-launcher.is-open .launcher-icon-chat {\n            display: none;\n        }\n        .n8n-chat-widget .chat-launcher.is-open .launcher-icon-close {\n            display: block;\n        }\n    `;document.head.appendChild(styles);let sessionId="";let isWaiting=false;const widget=document.createElement("div");widget.className="n8n-chat-widget";const avatarHtml=config.branding.showBotAvatar&&config.branding.botAvatar?`<img class="chat-avatar" src="${config.branding.botAvatar}" alt="${config.branding.botName}">`:`<div class="chat-avatar" style="display:flex;align-items:center;justify-content:center;font-size:18px;background:rgba(255,255,255,0.2);">ü§ñ</div>`;const footerClass=config.branding.showFooter?"":" hidden";const portalClass=config.portalButton.enabled?"":" hidden";const portalTarget=config.portalButton.openInNewTab?' target="_blank" rel="noopener noreferrer"':"";widget.innerHTML=`\n        <div class="chat-window">\n            <div class="chat-header">\n                ${avatarHtml}\n                <div class="chat-header-info">\n                    <div class="chat-header-name">${config.branding.botName}</div>\n                    <div class="chat-header-status">\n                        <span class="status-dot"></span>\n                        ${config.branding.botStatus}\n                    </div>\n                </div>\n                <button class="chat-close">&times;</button>\n            </div>\n\n            <div class="welcome-screen">\n                ${config.branding.botAvatar?`<img class="welcome-avatar" src="${config.branding.botAvatar}" alt="${config.branding.botName}">`:""}\n                <div class="welcome-title">${config.branding.welcomeTitle}</div>\n                <div class="welcome-subtitle">${config.branding.welcomeSubtitle}</div>\n                <div class="welcome-subtitle-small">${config.branding.welcomeQuestion||""}</div>\n                <button class="welcome-start">\n                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>\n                    </svg>\n                    ${config.branding.welcomeButtonText}\n                </button>\n                <a class="welcome-portal${portalClass}" href="${config.portalButton.url}"${portalTarget}>\n                    ${config.portalButton.text}\n                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>\n                        <polyline points="15 3 21 3 21 9"></polyline>\n                        <line x1="10" y1="14" x2="21" y2="3"></line>\n                    </svg>\n                </a>\n            </div>\n\n            <div class="chat-body">\n                <div class="chat-messages"></div>\n                <div class="chat-input-area">\n                    <textarea class="chat-input" placeholder="${config.branding.inputPlaceholder}" rows="1"></textarea>\n                    <button class="chat-send">\n                        <svg viewBox="0 0 24 24" fill="currentColor" stroke="none">\n                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>\n                        </svg>\n                    </button>\n                </div>\n                <a class="portal-button${portalClass}" href="${config.portalButton.url}"${portalTarget}>\n                    <span class="portal-label">${config.portalButton.text}</span>\n                    <span class="portal-action">\n                        ${config.portalButton.actionText}\n                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>\n                            <polyline points="15 3 21 3 21 9"></polyline>\n                            <line x1="10" y1="14" x2="21" y2="3"></line>\n                        </svg>\n                    </span>\n                </a>\n                <div class="chat-footer${footerClass}">\n                    <a href="${config.branding.footerLink}" target="_blank">${config.branding.footerText}</a>\n                </div>\n            </div>\n        </div>\n\n        <button class="chat-launcher">\n            <svg class="launcher-icon-chat" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>\n            </svg>\n            <svg class="launcher-icon-close" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">\n                <line x1="18" y1="6" x2="6" y2="18"></line>\n                <line x1="6" y1="6" x2="18" y2="18"></line>\n            </svg>\n        </button>\n    `;document.body.appendChild(widget);const chatWindow=widget.querySelector(".chat-window");const welcomeScreen=widget.querySelector(".welcome-screen");const chatBody=widget.querySelector(".chat-body");const messagesContainer=widget.querySelector(".chat-messages");const inputField=widget.querySelector(".chat-input");const sendBtn=widget.querySelector(".chat-send");const launcherBtn=widget.querySelector(".chat-launcher");const closeBtn=widget.querySelector(".chat-close");const startBtn=widget.querySelector(".welcome-start");function generateSessionId(){return"sess_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}function getTimestamp(){const now=new Date;return now.getHours().toString().padStart(2,"0")+":"+now.getMinutes().toString().padStart(2,"0")}function parseResponse(text){let cleanText=text;const quickReplies=[];const actionButtons=[];let formConfig=null;const qrRegex=/\{([^}]+)\}/g;let qrMatch;while((qrMatch=qrRegex.exec(text))!==null){const options=qrMatch[1].split("|").map((o=>o.trim())).filter((o=>o));quickReplies.push(...options)}cleanText=cleanText.replace(qrRegex,"");const btnRegex=/\[([^\]]+)\]\s*=\s*\[([^\]]+)\]/g;let btnMatch;while((btnMatch=btnRegex.exec(text))!==null){actionButtons.push({label:btnMatch[1].trim(),value:btnMatch[2].trim()})}cleanText=cleanText.replace(btnRegex,"");const formRegex=/\[FORM\]([\s\S]*?)\[\/FORM\]/i;const formMatch=text.match(formRegex);if(formMatch){try{formConfig=JSON.parse(formMatch[1].trim())}catch(e){console.error("Invalid form JSON:",e)}}cleanText=cleanText.replace(formRegex,"");cleanText=cleanText.replace(/\n{3,}/g,"\n\n").trim();return{text:cleanText,quickReplies:quickReplies,actionButtons:actionButtons,form:formConfig}}function formatText(text){return text.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/\n/g,"<br>").replace(/(https?:\/\/[^\s<]+)/g,'<a href="$1" target="_blank">$1</a>')}function showTyping(){const typing=document.createElement("div");typing.className="typing";typing.innerHTML='<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';messagesContainer.appendChild(typing);messagesContainer.scrollTop=messagesContainer.scrollHeight;return typing}function addMessage(content,isUser=false,isError=false){if(!isUser&&!isError){const row=document.createElement("div");row.className="message-row bot-row";const avatarEl=document.createElement("div");if(config.branding.showBotAvatar&&config.branding.botAvatar){avatarEl.className="msg-avatar";const img=document.createElement("img");img.src=config.branding.botAvatar;img.alt=config.branding.botName;avatarEl.appendChild(img)}else{avatarEl.className="msg-avatar";avatarEl.textContent="ü§ñ";avatarEl.style.fontSize="14px"}const msg=document.createElement("div");msg.className="message bot";msg.innerHTML=formatText(content);row.appendChild(avatarEl);row.appendChild(msg);messagesContainer.appendChild(row)}else if(isUser){const msg=document.createElement("div");msg.className="message user";msg.innerHTML=formatText(content);messagesContainer.appendChild(msg)}const time=document.createElement("div");time.className=`message-time${isUser?" user-time":""}`;time.textContent=getTimestamp();messagesContainer.appendChild(time);messagesContainer.scrollTop=messagesContainer.scrollHeight}function addErrorMessage(errorMsg,lastMessageText){const row=document.createElement("div");row.className="message-row bot-row";const avatarEl=document.createElement("div");avatarEl.className="msg-avatar";avatarEl.textContent="ü§ñ";avatarEl.style.fontSize="14px";const msg=document.createElement("div");msg.className="message error";const title=document.createElement("div");title.className="error-title";title.textContent=config.messages.errorTitle;const detail=document.createElement("div");detail.className="error-detail";detail.textContent=errorMsg;const retry=document.createElement("div");retry.className="error-retry";retry.textContent=config.messages.errorRetry;retry.addEventListener("click",(()=>{const timeEl=row.nextElementSibling;if(timeEl&&timeEl.classList.contains("message-time"))timeEl.remove();row.remove();if(lastMessageText){sendMessage(lastMessageText)}}));msg.appendChild(title);msg.appendChild(detail);msg.appendChild(retry);row.appendChild(avatarEl);row.appendChild(msg);messagesContainer.appendChild(row);const time=document.createElement("div");time.className="message-time";time.textContent=getTimestamp();messagesContainer.appendChild(time);messagesContainer.scrollTop=messagesContainer.scrollHeight}function addQuickReplies(options){if(!options.length)return;const container=document.createElement("div");container.className="quick-replies";options.forEach((opt=>{const btn=document.createElement("button");btn.className="quick-reply-btn";btn.textContent=opt;btn.onclick=()=>{container.querySelectorAll(".quick-reply-btn").forEach((b=>b.classList.add("clicked")));sendMessage(opt)};container.appendChild(btn)}));messagesContainer.appendChild(container);messagesContainer.scrollTop=messagesContainer.scrollHeight}function addActionButtons(buttons){if(!buttons.length)return;const container=document.createElement("div");container.className="action-buttons";buttons.forEach((btn=>{const button=document.createElement("button");button.className="action-btn";button.textContent=btn.label;button.onclick=()=>{container.querySelectorAll(".action-btn").forEach((b=>b.classList.add("clicked")));sendMessage(btn.value)};container.appendChild(button)}));messagesContainer.appendChild(container);messagesContainer.scrollTop=messagesContainer.scrollHeight}function addDynamicForm(formConfig){if(!formConfig)return;const container=document.createElement("div");container.className="dynamic-form";const cols=formConfig.columns||1;const colClass=cols===2?"cols-2":"";let html=formConfig.title?`<div class="form-title">${formConfig.title}</div>`:"";html+=`<form class="form-grid ${colClass}">`;formConfig.fields.forEach((field=>{const fullWidth=field.fullWidth||["textarea","radio","checkbox"].includes(field.type);const reqClass=field.required?"required":"";html+=`<div class="form-field ${fullWidth?"full-width":""}">`;html+=`<label class="form-label ${reqClass}">${field.label}</label>`;switch(field.type){case"select":html+=`<select class="form-select" name="${field.name}" ${field.required?"required":""}>`;html+=`<option value="">${field.placeholder||"Bitte w√§hlen..."}</option>`;(field.options||[]).forEach((opt=>{html+=`<option value="${opt}">${opt}</option>`}));html+=`</select>`;break;case"textarea":html+=`<textarea class="form-textarea" name="${field.name}" placeholder="${field.placeholder||""}" rows="${field.rows||3}" ${field.required?"required":""}></textarea>`;break;case"radio":html+=`<div class="option-group">`;(field.options||[]).forEach(((opt,i)=>{html+=`<label class="option-item"><input type="radio" name="${field.name}" value="${opt}" ${field.required&&i===0?"required":""}><span>${opt}</span></label>`}));html+=`</div>`;break;case"checkbox":html+=`<div class="option-group">`;(field.options||[]).forEach((opt=>{html+=`<label class="option-item"><input type="checkbox" name="${field.name}" value="${opt}"><span>${opt}</span></label>`}));html+=`</div>`;break;case"range":const min=field.min||0;const max=field.max||100;const val=field.default||Math.round((min+max)/2);html+=`<div class="range-container">`;html+=`<input type="range" class="range-input" name="${field.name}" min="${min}" max="${max}" value="${val}">`;html+=`<div class="range-value">${val}</div>`;html+=`</div>`;break;default:html+=`<input class="form-input" type="${field.type||"text"}" name="${field.name}" placeholder="${field.placeholder||""}" ${field.required?"required":""}>`}html+=`</div>`}));html+=`<button type="submit" class="form-submit">${formConfig.submitText||"Absenden"}</button>`;html+=`</form>`;container.innerHTML=html;container.querySelectorAll(".range-input").forEach((range=>{range.addEventListener("input",(e=>{e.target.parentElement.querySelector(".range-value").textContent=e.target.value}))}));container.querySelector("form").addEventListener("submit",(e=>{e.preventDefault();const formData=new FormData(e.target);const data={};container.querySelectorAll('input[type="checkbox"]').forEach((cb=>{if(!data[cb.name])data[cb.name]=[]}));for(const[key,value]of formData.entries()){const field=formConfig.fields.find((f=>f.name===key));if(field&&field.type==="checkbox"){if(!data[key])data[key]=[];data[key].push(value)}else{data[key]=value}}Object.keys(data).forEach((key=>{if(Array.isArray(data[key])){data[key]=data[key].join(", ")}}));container.classList.add("submitted");container.querySelector(".form-submit").textContent=config.messages.formSubmitted;let summary=formConfig.title?`üìã **${formConfig.title}**\n\n`:"üìã **Formulardaten:**\n\n";formConfig.fields.forEach((field=>{if(data[field.name]){summary+=`**${field.label}:** ${data[field.name]}\n`}}));sendMessage(summary.trim())}));messagesContainer.appendChild(container);messagesContainer.scrollTop=messagesContainer.scrollHeight}async function sendMessage(text){if(isWaiting||!text.trim())return;isWaiting=true;addMessage(text,true);const typing=showTyping();const controller=new AbortController;const timeoutId=setTimeout((()=>controller.abort()),config.behavior.requestTimeout);try{const response=await fetch(config.webhook.url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"sendMessage",sessionId:sessionId,route:config.webhook.route,chatInput:text}),signal:controller.signal});clearTimeout(timeoutId);typing.remove();if(!response.ok)throw new Error("HTTP "+response.status);const data=await response.json();const output=Array.isArray(data)?data[0].output:data.output;const parsed=parseResponse(output);if(parsed.text)addMessage(parsed.text);if(parsed.quickReplies.length)addQuickReplies(parsed.quickReplies);if(parsed.actionButtons.length)addActionButtons(parsed.actionButtons);if(parsed.form)addDynamicForm(parsed.form)}catch(error){clearTimeout(timeoutId);typing.remove();let errorDetail=config.messages.errorGeneral;if(error.name==="AbortError"){errorDetail=config.messages.errorTimeout}else if(error.message.includes("fetch")){errorDetail=config.messages.errorNetwork}addErrorMessage(errorDetail,text);console.error("Chat error:",error)}isWaiting=false}function startChat(){sessionId=generateSessionId();welcomeScreen.classList.add("hidden");chatBody.classList.add("active");if(config.initialMessage.enabled&&config.initialMessage.message){setTimeout((()=>{const parsed=parseResponse(config.initialMessage.message);if(parsed.text)addMessage(parsed.text);if(parsed.quickReplies.length)addQuickReplies(parsed.quickReplies);if(parsed.actionButtons.length)addActionButtons(parsed.actionButtons);if(parsed.form)addDynamicForm(parsed.form)}),config.initialMessage.delay)}}function toggleChat(){const isOpen=chatWindow.classList.toggle("open");launcherBtn.classList.toggle("is-open",isOpen)}launcherBtn.addEventListener("click",toggleChat);closeBtn.addEventListener("click",(()=>{chatWindow.classList.remove("open");launcherBtn.classList.remove("is-open")}));startBtn.addEventListener("click",startChat);sendBtn.addEventListener("click",(()=>{sendMessage(inputField.value);inputField.value="";inputField.style.height="auto"}));inputField.addEventListener("keypress",(e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();sendMessage(inputField.value);inputField.value="";inputField.style.height="auto"}}));inputField.addEventListener("input",(()=>{inputField.style.height="auto";inputField.style.height=Math.min(inputField.scrollHeight,100)+"px"}));if(config.behavior.autoOpen){setTimeout((()=>{chatWindow.classList.add("open");launcherBtn.classList.add("is-open")}),config.behavior.autoOpenDelay)}window.N8nChatWidget={open:function(){chatWindow.classList.add("open");launcherBtn.classList.add("is-open")},close:function(){chatWindow.classList.remove("open");launcherBtn.classList.remove("is-open")},toggle:function(){toggleChat()}};document.addEventListener("click",(function(e){const trigger=e.target.closest("[data-open-chat]");if(trigger){e.preventDefault();chatWindow.classList.add("open");launcherBtn.classList.add("is-open")}}))})();